<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shortener met Firebase Tracking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .header .info-text {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 10px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            display: none;
            padding: 20px;
            background: #f0f4ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .result.show {
            display: block;
        }

        .short-url {
            font-size: 18px;
            color: #667eea;
            word-break: break-all;
            margin: 10px 0;
            font-weight: 600;
        }

        .copy-btn {
            padding: 10px 20px;
            font-size: 14px;
            margin-top: 10px;
        }

        .links-list {
            margin-top: 30px;
        }

        .link-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .link-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .original-url {
            color: #666;
            font-size: 14px;
            word-break: break-all;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .visits-table {
            margin-top: 15px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .toggle-btn {
            padding: 8px 15px;
            font-size: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .redirect-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        .redirect-screen.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }



        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="redirect-screen" id="redirectScreen">
        <div class="spinner"></div>
        <h2>Bezoek wordt geregistreerd...</h2>
        <p>Je wordt doorgestuurd naar de originele link</p>
    </div>

    <div class="container" id="mainContent">
        <div class="header">
            <h1>ðŸ”— URL Shortener</h1>
            <p>Maak verkorte links en track bezoekers</p>
            <p class="info-text">ðŸ”¥ Powered by Firebase - Real-time synchronisatie</p>
        </div>

        <div class="card">
            <h2>Nieuwe Link Maken</h2>
            <div class="input-group">
                <input type="text" id="urlInput" placeholder="Plak hier je lange URL...">
                <button onclick="createShortUrl()" id="createBtn">Verkorten</button>
            </div>
            
            <div id="result" class="result">
                <p><strong>Je verkorte link:</strong></p>
                <div class="short-url" id="shortUrl"></div>
                <button class="copy-btn" onclick="copyToClipboard()">ðŸ“‹ Kopieer Link</button>
            </div>
        </div>

        <div class="card">
            <h2>Mijn Links Dashboard</h2>
            <p style="margin-bottom: 20px; color: #666;">Real-time updates - data wordt automatisch gesynchroniseerd!</p>
            <div id="linksList"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // ====================================
        // VERVANG DIT MET JOUW FIREBASE CONFIG
        // ====================================
        const firebaseConfig = {
            apiKey: "AIzaSyAmncAYmW_jAthaasN47nMLPnIQMcEwXXU",
            authDomain: "url-tracker-918c7.firebaseapp.com",
            projectId: "url-tracker-918c7",
            storageBucket: "url-tracker-918c7.firebasestorage.app",
            messagingSenderId: "1034087363063",
            appId: "1:1034087363063:web:1b5cd61c4885bb1350fef2"
        };
        // ====================================

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('âœ… Firebase verbonden!');
        } catch (error) {
            console.error('âŒ Firebase configuratie fout:', error);
            alert('Firebase configuratie fout! Check de console en je firebaseConfig.');
        }

        // LocalStorage key voor mijn links
        const MY_LINKS_KEY = 'myCreatedLinks';

        // Haal mijn gemaakte links op
        function getMyLinks() {
            const links = localStorage.getItem(MY_LINKS_KEY);
            return links ? JSON.parse(links) : [];
        }

        // Voeg link toe aan mijn lijst
        function addMyLink(linkId) {
            const myLinks = getMyLinks();
            if (!myLinks.includes(linkId)) {
                myLinks.push(linkId);
                localStorage.setItem(MY_LINKS_KEY, JSON.stringify(myLinks));
            }
        }

        // Verwijder link uit mijn lijst
        function removeMyLink(linkId) {
            let myLinks = getMyLinks();
            myLinks = myLinks.filter(id => id !== linkId);
            localStorage.setItem(MY_LINKS_KEY, JSON.stringify(myLinks));
        }

        // Haal IP en browser info op
        async function getVisitorInfo() {
            const info = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screenResolution: `${screen.width}x${screen.height}`,
                referrer: document.referrer || 'Direct'
            };

            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                info.ip = data.ip;
            } catch (e) {
                info.ip = 'Onbekend';
            }

            return info;
        }

        function parseBrowser(userAgent) {
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Chrome') && !userAgent.includes('Edge')) return 'Chrome';
            if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) return 'Safari';
            if (userAgent.includes('Edge')) return 'Edge';
            return 'Anders';
        }

        function parseOS(userAgent) {
            if (userAgent.includes('Windows')) return 'Windows';
            if (userAgent.includes('Mac')) return 'macOS';
            if (userAgent.includes('Linux')) return 'Linux';
            if (userAgent.includes('Android')) return 'Android';
            if (userAgent.includes('iOS')) return 'iOS';
            return 'Anders';
        }

        // Check redirect
        async function checkRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            const r = urlParams.get('r');
            
            if (r) {
                document.getElementById('redirectScreen').classList.add('active');
                document.getElementById('mainContent').style.display = 'none';
                
                try {
                    const decoded = atob(r);
                    const visitorInfo = await getVisitorInfo();
                    
                    // Sla visit op in Firebase
                    await db.collection('visits').add({
                        linkId: r,
                        originalUrl: decoded,
                        ip: visitorInfo.ip,
                        browser: parseBrowser(visitorInfo.userAgent),
                        os: parseOS(visitorInfo.userAgent),
                        screen: visitorInfo.screenResolution,
                        referrer: visitorInfo.referrer,
                        userAgent: visitorInfo.userAgent,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update visit counter
                    const linkRef = db.collection('links').doc(r);
                    await linkRef.update({
                        visitCount: firebase.firestore.FieldValue.increment(1),
                        lastVisit: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    setTimeout(() => {
                        window.location.href = decoded;
                    }, 1500);
                } catch (e) {
                    console.error('Redirect error:', e);
                    alert('Ongeldige link');
                    window.location.href = window.location.origin;
                }
            }
        }

        async function createShortUrl() {
            const input = document.getElementById('urlInput');
            const url = input.value.trim();
            
            if (!url) {
                alert('Voer een URL in!');
                return;
            }

            try {
                new URL(url);
            } catch (e) {
                alert('Voer een geldige URL in (bijv. https://example.com)');
                return;
            }

            const encoded = btoa(url);
            const shortUrl = `${window.location.origin}${window.location.pathname}?r=${encoded}`;
            
            // Sla link op in Firebase
            try {
                // Check eerst of de link al bestaat
                const linkDoc = await db.collection('links').doc(encoded).get();
                
                if (!linkDoc.exists) {
                    // Link bestaat nog niet, maak hem aan
                    await db.collection('links').doc(encoded).set({
                        originalUrl: url,
                        shortUrl: shortUrl,
                        created: new Date(),
                        visitCount: 0
                    });
                }
                // Als link al bestaat, gewoon doorgaan (geen error)

                // Voeg toe aan MIJN links (ook als hij al bestond)
                addMyLink(encoded);

                document.getElementById('shortUrl').textContent = shortUrl;
                document.getElementById('result').classList.add('show');
                
                input.value = '';
                
                // Herlaad dashboard om nieuwe link te tonen
                loadDashboard();
            } catch (error) {
                console.error('Error creating link:', error);
                alert('Fout bij aanmaken link. Check console voor details.');
            }
        }

        function copyToClipboard() {
            const shortUrl = document.getElementById('shortUrl').textContent;
            navigator.clipboard.writeText(shortUrl).then(() => {
                alert('Link gekopieerd naar klembord!');
            });
        }

        // Real-time dashboard laden
        function loadDashboard() {
            const container = document.getElementById('linksList');
            const myLinks = getMyLinks();

            if (myLinks.length === 0) {
                container.innerHTML = '<div class="empty-state">Nog geen links gemaakt. Maak je eerste verkorte link hierboven!</div>';
                return;
            }

            container.innerHTML = '<div class="loading">Dashboard laden...</div>';

            // Luister alleen naar MIJN links
            let loadedCount = 0;
            let htmlParts = [];

            myLinks.forEach((linkId, index) => {
                db.collection('links').doc(linkId).onSnapshot(async (doc) => {
                    if (!doc.exists) {
                        // Link bestaat niet meer in database
                        removeMyLink(linkId);
                        loadedCount++;
                        checkIfAllLoaded();
                        return;
                    }

                    const data = doc.data();
                    const encoded = doc.id;
                    
                    // Haal visits op voor deze link
                    const visitsSnapshot = await db.collection('visits')
                        .where('linkId', '==', encoded)
                        .orderBy('timestamp', 'desc')
                        .get();
                    
                    const visits = visitsSnapshot.docs.map(d => d.data());
                    const totalVisits = visits.length;
                    const uniqueIPs = new Set(visits.map(v => v.ip)).size;
                    
                    const browsers = {};
                    const oses = {};
                    visits.forEach(visit => {
                        browsers[visit.browser] = (browsers[visit.browser] || 0) + 1;
                        oses[visit.os] = (oses[visit.os] || 0) + 1;
                    });

                    const createdDate = data.created ? (data.created.toDate ? data.created.toDate() : data.created) : new Date();

                    htmlParts[index] = `
                        <div class="link-item">
                            <div class="link-header">
                                <div>
                                    <div class="short-url">${data.shortUrl}</div>
                                    <div class="original-url">â†’ ${data.originalUrl}</div>
                                    <div class="original-url">Aangemaakt: ${createdDate.toLocaleString('nl-NL')}</div>
                                </div>
                                <button class="toggle-btn" onclick="toggleDetails('${encoded}')">
                                    Details Tonen
                                </button>
                            </div>
                            
                            <div class="stats">
                                <div class="stat-box">
                                    <div class="stat-value">${totalVisits}</div>
                                    <div class="stat-label">Totale Bezoeken</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value">${uniqueIPs}</div>
                                    <div class="stat-label">Unieke Bezoekers</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value">${Object.keys(browsers).length}</div>
                                    <div class="stat-label">Verschillende Browsers</div>
                                </div>
                                <div class="stat-box">
                                    <div class="stat-value">${Object.keys(oses).length}</div>
                                    <div class="stat-label">Verschillende OS</div>
                                </div>
                            </div>
                            
                            <div id="details-${encoded}" class="visits-table hidden">
                                <h3 style="margin: 20px 0 10px 0;">Bezoek Details</h3>
                                ${visits.length > 0 ? `
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Tijd</th>
                                                <th>IP Adres</th>
                                                <th>Browser</th>
                                                <th>OS</th>
                                                <th>Scherm</th>
                                                <th>Referrer</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${visits.map(visit => {
                                                const visitDate = visit.timestamp ? (visit.timestamp.toDate ? visit.timestamp.toDate() : new Date(visit.timestamp)) : new Date();
                                                return `
                                                <tr>
                                                    <td>${visitDate.toLocaleString('nl-NL')}</td>
                                                    <td><span class="badge">${visit.ip}</span></td>
                                                    <td>${visit.browser}</td>
                                                    <td>${visit.os}</td>
                                                    <td>${visit.screen}</td>
                                                    <td>${visit.referrer}</td>
                                                </tr>
                                            `}).join('')}
                                        </tbody>
                                    </table>
                                ` : '<p style="padding: 20px; text-align: center; color: #999;">Nog geen bezoeken</p>'}
                            </div>
                        </div>
                    `;

                    loadedCount++;
                    checkIfAllLoaded();
                }, (error) => {
                    console.error('Error loading link:', error);
                    loadedCount++;
                    checkIfAllLoaded();
                });
            });

            function checkIfAllLoaded() {
                if (loadedCount === myLinks.length) {
                    const html = '<div class="links-list">' + htmlParts.filter(h => h).join('') + '</div>';
                    container.innerHTML = html;
                }
            }
        }

        function toggleDetails(encoded) {
            const details = document.getElementById(`details-${encoded}`);
            details.classList.toggle('hidden');
        }

        // Initialiseer
        checkRedirect();
        
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.get('r')) {
            loadDashboard();
        }
    </script>
</body>
</html>
