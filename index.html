<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL Shortener met Tracking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .header .info-text {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 10px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .webhook-setup {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .webhook-setup h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .webhook-setup input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 14px;
            margin-top: 10px;
        }

        .webhook-setup button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 14px;
        }

        .webhook-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }

        .webhook-status.success {
            background: #d4edda;
            color: #155724;
        }

        .webhook-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            display: none;
            padding: 20px;
            background: #f0f4ff;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .result.show {
            display: block;
        }

        .short-url {
            font-size: 18px;
            color: #667eea;
            word-break: break-all;
            margin: 10px 0;
            font-weight: 600;
        }

        .copy-btn {
            padding: 10px 20px;
            font-size: 14px;
            margin-top: 10px;
        }

        .links-list {
            margin-top: 30px;
        }

        .link-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .link-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .original-url {
            color: #666;
            font-size: 14px;
            word-break: break-all;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .visits-table {
            margin-top: 15px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .toggle-btn {
            padding: 8px 15px;
            font-size: 14px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .danger-zone {
            margin-top: 30px;
            padding: 20px;
            background: #fff5f5;
            border: 2px solid #feb2b2;
            border-radius: 8px;
        }

        .danger-zone h3 {
            color: #c53030;
            margin-bottom: 10px;
        }

        .danger-zone p {
            color: #742a2a;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .delete-btn {
            background: #c53030;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .delete-btn:hover {
            background: #9b2c2c;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-content h2 {
            color: #c53030;
            margin-bottom: 15px;
        }

        .modal-content p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-cancel {
            padding: 12px 24px;
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel:hover {
            background: #cbd5e0;
        }

        .btn-confirm {
            padding: 12px 24px;
            background: #c53030;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-confirm:hover {
            background: #9b2c2c;
        }

        .redirect-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        .redirect-screen.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="redirect-screen" id="redirectScreen">
        <div class="spinner"></div>
        <h2>Bezoek wordt geregistreerd...</h2>
        <p>Je wordt doorgestuurd naar de originele link</p>
    </div>

    <div class="container" id="mainContent">
        <div class="header">
            <h1>🔗 URL Shortener</h1>
            <p>Maak verkorte links en track bezoekers</p>
            <p class="info-text">💡 Data wordt real-time gesynchroniseerd via Discord</p>
        </div>

        <div class="card">
            <div class="webhook-setup" id="webhookSetup">
                <h3>⚙️ Discord Webhook Setup</h3>
                <p>Plak je Discord webhook URL hieronder om tracking te activeren:</p>
                <input type="text" id="webhookInput" placeholder="https://discord.com/api/webhooks/...">
                <button onclick="saveWebhook()">Opslaan</button>
                <div id="webhookStatus"></div>
            </div>

            <h2>Nieuwe Link Maken</h2>
            <div class="input-group">
                <input type="text" id="urlInput" placeholder="Plak hier je lange URL...">
                <button onclick="createShortUrl()" id="createBtn">Verkorten</button>
            </div>
            
            <div id="result" class="result">
                <p><strong>Je verkorte link:</strong></p>
                <div class="short-url" id="shortUrl"></div>
                <button class="copy-btn" onclick="copyToClipboard()">📋 Kopieer Link</button>
            </div>
        </div>

        <div class="card">
            <h2>Mijn Links Dashboard</h2>
            <button onclick="loadDashboard()" style="margin-bottom: 20px;">🔄 Dashboard Verversen</button>
            <div id="linksList"></div>
            
            <div class="danger-zone">
                <h3>⚠️ Danger Zone</h3>
                <p>Wis alle links en bezoekgeschiedenis. Deze actie kan niet ongedaan gemaakt worden!</p>
                <button class="delete-btn" onclick="showDeleteModal()">🗑️ Alles Wissen</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <h2>⚠️ Weet je het zeker?</h2>
            <p>Je staat op het punt om <strong>ALLE links en bezoekgegevens permanent te verwijderen</strong>. Dit verwijdert ook alle berichten in je Discord channel!</p>
            <p>Wil je echt doorgaan?</p>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideDeleteModal()">Annuleren</button>
                <button class="btn-confirm" onclick="confirmDelete()">Ja, Alles Wissen</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'urlShortenerData';
        const WEBHOOK_KEY = 'discordWebhookUrl';

        // Haal webhook URL op
        function getWebhookUrl() {
            return localStorage.getItem(WEBHOOK_KEY);
        }

        // Sla webhook URL op
        function saveWebhook() {
            const input = document.getElementById('webhookInput');
            const url = input.value.trim();
            
            if (!url) {
                showWebhookStatus('Voer een webhook URL in!', 'error');
                return;
            }

            if (!url.includes('discord.com/api/webhooks/')) {
                showWebhookStatus('Ongeldige Discord webhook URL!', 'error');
                return;
            }

            localStorage.setItem(WEBHOOK_KEY, url);
            showWebhookStatus('✅ Webhook opgeslagen! Tracking is nu actief.', 'success');
            
            // Verberg setup na opslaan
            setTimeout(() => {
                document.getElementById('webhookSetup').style.display = 'none';
            }, 2000);
        }

        function showWebhookStatus(message, type) {
            const status = document.getElementById('webhookStatus');
            status.textContent = message;
            status.className = `webhook-status ${type}`;
            status.style.display = 'block';
        }

        // Check of webhook is ingesteld
        function checkWebhook() {
            const webhook = getWebhookUrl();
            if (webhook) {
                document.getElementById('webhookSetup').style.display = 'none';
            } else {
                document.getElementById('createBtn').disabled = true;
            }
        }

        // Stuur data naar Discord
        async function sendToDiscord(type, data) {
            const webhook = getWebhookUrl();
            if (!webhook) return false;

            let embed;

            if (type === 'new_link') {
                embed = {
                    title: '🔗 Nieuwe Link Aangemaakt',
                    color: 0x667eea,
                    fields: [
                        {
                            name: 'Short ID',
                            value: `\`${data.shortId}\``,
                            inline: false
                        },
                        {
                            name: 'Originele URL',
                            value: data.originalUrl,
                            inline: false
                        },
                        {
                            name: 'Korte Link',
                            value: data.shortUrl,
                            inline: false
                        }
                    ],
                    timestamp: new Date().toISOString()
                };
            } else if (type === 'visit') {
                embed = {
                    title: '👀 Nieuwe Bezoeker',
                    color: 0x43b581,
                    fields: [
                        {
                            name: 'Link ID',
                            value: `\`${data.shortId}\``,
                            inline: true
                        },
                        {
                            name: 'IP Adres',
                            value: data.ip,
                            inline: true
                        },
                        {
                            name: 'Browser',
                            value: data.browser,
                            inline: true
                        },
                        {
                            name: 'OS',
                            value: data.os,
                            inline: true
                        },
                        {
                            name: 'Scherm',
                            value: data.screen,
                            inline: true
                        },
                        {
                            name: 'Referrer',
                            value: data.referrer,
                            inline: true
                        }
                    ],
                    timestamp: new Date().toISOString(),
                    footer: {
                        text: `Originele URL: ${data.originalUrl}`
                    }
                };
            }

            try {
                await fetch(webhook, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        embeds: [embed]
                    })
                });
                return true;
            } catch (e) {
                console.error('Discord webhook error:', e);
                return false;
            }
        }

        // Haal IP en browser info op
        async function getVisitorInfo() {
            const info = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screenResolution: `${screen.width}x${screen.height}`,
                referrer: document.referrer || 'Direct'
            };

            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                info.ip = data.ip;
            } catch (e) {
                info.ip = 'Onbekend';
            }

            return info;
        }

        function parseBrowser(userAgent) {
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Chrome') && !userAgent.includes('Edge')) return 'Chrome';
            if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) return 'Safari';
            if (userAgent.includes('Edge')) return 'Edge';
            return 'Anders';
        }

        function parseOS(userAgent) {
            if (userAgent.includes('Windows')) return 'Windows';
            if (userAgent.includes('Mac')) return 'macOS';
            if (userAgent.includes('Linux')) return 'Linux';
            if (userAgent.includes('Android')) return 'Android';
            if (userAgent.includes('iOS')) return 'iOS';
            return 'Anders';
        }

        // Check redirect
        async function checkRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            const r = urlParams.get('r');
            
            if (r) {
                document.getElementById('redirectScreen').classList.add('active');
                document.getElementById('mainContent').style.display = 'none';
                
                try {
                    const decoded = atob(r);
                    const visitorInfo = await getVisitorInfo();
                    
                    // Stuur naar Discord
                    await sendToDiscord('visit', {
                        shortId: r.substring(0, 8),
                        originalUrl: decoded,
                        ip: visitorInfo.ip,
                        browser: parseBrowser(visitorInfo.userAgent),
                        os: parseOS(visitorInfo.userAgent),
                        screen: visitorInfo.screenResolution,
                        referrer: visitorInfo.referrer
                    });
                    
                    // Lokaal ook opslaan
                    const linksData = getLinksData();
                    if (!linksData[r]) {
                        linksData[r] = {
                            originalUrl: decoded,
                            created: new Date().toISOString(),
                            visits: []
                        };
                    }
                    linksData[r].visits.push(visitorInfo);
                    saveLinksData(linksData);
                    
                    setTimeout(() => {
                        window.location.href = decoded;
                    }, 1500);
                } catch (e) {
                    alert('Ongeldige link');
                    window.location.href = window.location.origin;
                }
            }
        }

        function getLinksData() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : {};
        }

        function saveLinksData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        async function createShortUrl() {
            const input = document.getElementById('urlInput');
            const url = input.value.trim();
            
            if (!url) {
                alert('Voer een URL in!');
                return;
            }

            try {
                new URL(url);
            } catch (e) {
                alert('Voer een geldige URL in (bijv. https://example.com)');
                return;
            }

            const encoded = btoa(url);
            const shortUrl = `${window.location.origin}${window.location.pathname}?r=${encoded}`;
            
            // Stuur naar Discord
            await sendToDiscord('new_link', {
                shortId: encoded.substring(0, 8),
                originalUrl: url,
                shortUrl: shortUrl
            });

            const linksData = getLinksData();
            if (!linksData[encoded]) {
                linksData[encoded] = {
                    originalUrl: url,
                    created: new Date().toISOString(),
                    visits: []
                };
            }
            saveLinksData(linksData);

            document.getElementById('shortUrl').textContent = shortUrl;
            document.getElementById('result').classList.add('show');
            
            loadDashboard();
            input.value = '';
        }

        function copyToClipboard() {
            const shortUrl = document.getElementById('shortUrl').textContent;
            navigator.clipboard.writeText(shortUrl).then(() => {
                alert('Link gekopieerd naar klembord!');
            });
        }

        function loadDashboard() {
            const container = document.getElementById('linksList');
            const linksData = getLinksData();
            
            if (Object.keys(linksData).length === 0) {
                container.innerHTML = '<div class="empty-state">Nog geen links gemaakt. Maak je eerste verkorte link hierboven!</div>';
                return;
            }

            let html = '<div class="links-list">';
            
            for (const [encoded, data] of Object.entries(linksData)) {
                const shortUrl = `${window.location.origin}${window.location.pathname}?r=${encoded}`;
                const totalVisits = data.visits.length;
                const uniqueIPs = new Set(data.visits.map(v => v.ip)).size;
                
                const browsers = {};
                const oses = {};
                data.visits.forEach(visit => {
                    const browser = parseBrowser(visit.userAgent);
                    const os = parseOS(visit.userAgent);
                    browsers[browser] = (browsers[browser] || 0) + 1;
                    oses[os] = (oses[os] || 0) + 1;
                });

                html += `
                    <div class="link-item">
                        <div class="link-header">
                            <div>
                                <div class="short-url">${shortUrl}</div>
                                <div class="original-url">→ ${data.originalUrl}</div>
                            </div>
                            <button class="toggle-btn" onclick="toggleDetails('${encoded}')">
                                Details Tonen
                            </button>
                        </div>
                        
                        <div class="stats">
                            <div class="stat-box">
                                <div class="stat-value">${totalVisits}</div>
                                <div class="stat-label">Totale Bezoeken</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${uniqueIPs}</div>
                                <div class="stat-label">Unieke Bezoekers</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${Object.keys(browsers).length}</div>
                                <div class="stat-label">Verschillende Browsers</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${Object.keys(oses).length}</div>
                                <div class="stat-label">Verschillende OS</div>
                            </div>
                        </div>
                        
                        <div id="details-${encoded}" class="visits-table hidden">
                            <h3 style="margin: 20px 0 10px 0;">Bezoek Details</h3>
                            ${data.visits.length > 0 ? `
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Tijd</th>
                                            <th>IP Adres</th>
                                            <th>Browser</th>
                                            <th>OS</th>
                                            <th>Scherm</th>
                                            <th>Referrer</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.visits.map(visit => `
                                            <tr>
                                                <td>${new Date(visit.timestamp).toLocaleString('nl-NL')}</td>
                                                <td><span class="badge">${visit.ip}</span></td>
                                                <td>${parseBrowser(visit.userAgent)}</td>
                                                <td>${parseOS(visit.userAgent)}</td>
                                                <td>${visit.screenResolution}</td>
                                                <td>${visit.referrer}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            ` : '<p style="padding: 20px; text-align: center; color: #999;">Nog geen bezoeken</p>'}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function toggleDetails(encoded) {
            const details = document.getElementById(`details-${encoded}`);
            details.classList.toggle('hidden');
        }

        function showDeleteModal() {
            document.getElementById('deleteModal').classList.add('active');
        }

        function hideDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }

        async function confirmDelete() {
            // Stuur delete notificatie naar Discord
            const webhook = getWebhookUrl();
            if (webhook) {
                await fetch(webhook, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        embeds: [{
                            title: '🗑️ Alle Data Gewist',
                            description: 'Alle links en bezoekgeschiedenis zijn verwijderd.',
                            color: 0xff0000,
                            timestamp: new Date().toISOString()
                        }]
                    })
                });
            }

            localStorage.removeItem(STORAGE_KEY);
            hideDeleteModal();
            loadDashboard();
            alert('✅ Alle links en geschiedenis zijn gewist!');
        }

        // Initialiseer
        checkWebhook();
        checkRedirect();
        
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.get('r')) {
            loadDashboard();
        }
    </script>
</body>
</html>
